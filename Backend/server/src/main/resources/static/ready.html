<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pending Orders</title>
</head>
<body>
    <h1>픽업 대기 중인 주문</h1>

    <label for="storeSelector">매장 선택:</label>
    <select id="storeSelector">
        <option value="all">전체</option>
    </select>

    <div id="orders"></div>

    <script>
        let stores = []; // 매장 목록 저장

        // 전체 매장 정보를 가져와서 드롭다운에 추가
        function fetchStores() {
            fetch('/rest/shop')
                .then(response => response.json())
                .then(data => {
                    const storeSelector = document.getElementById('storeSelector');
                    stores = data;

                    data.forEach(store => {
                        const option = document.createElement('option');
                        option.value = store.name;
                        option.innerText = store.name;
                        storeSelector.appendChild(option);
                    });
                });
        }

        // 픽업 대기 중인 주문을 가져와서 표시
        function fetchPendingOrders() {
            fetch('/rest/ready/pendingOrders')
                .then(response => response.json())
                .then(data => {
                    const selectedStore = document.getElementById('storeSelector').value;
                    const ordersDiv = document.getElementById('orders');
                    ordersDiv.innerHTML = ''; // 이전 내용 제거

                    // 매장 필터링 (전체 또는 특정 매장)
                    const filteredOrders = selectedStore === 'all' 
                        ? data 
                        : data.filter(order => order.orderTable.includes(selectedStore));

                    filteredOrders.forEach(order => {
                        const orderDiv = document.createElement('div');
                        orderDiv.style.border = '1px solid black';
                        orderDiv.style.padding = '10px';
                        orderDiv.style.margin = '10px';

                        const { tableInfo, storeName } = parseOrderTable(order.orderTable);

                        const orderInfo = document.createElement('p');
                        orderInfo.innerText = `주문 번호: ${order.id}, 사용자 ID: ${order.userId}, 주문 시간: ${new Date(order.orderTime).toLocaleString()}, ${tableInfo} (${storeName})`;
                        orderDiv.appendChild(orderInfo);

                        const detailsList = document.createElement('ul');
                        order.details.forEach(detail => {
                            const detailItem = document.createElement('li');
                            detailItem.innerText = `${detail.name} x ${detail.quantity}`;
                            detailsList.appendChild(detailItem);
                        });
                        orderDiv.appendChild(detailsList);

                        const readyButton = document.createElement('button');
                        readyButton.innerText = 'Ready';
                        readyButton.onclick = function() {
                            updatePickUpStatus(order.id);
                        };
                        orderDiv.appendChild(readyButton);

                        ordersDiv.appendChild(orderDiv);
                    });
                });
        }

        // 픽업 상태를 업데이트
        function updatePickUpStatus(orderId) {
            fetch('/rest/ready/' + orderId, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(true)
            })
            .then(response => response.json())
            .then(data => {
                if (data) {
                    alert('주문 ' + orderId + '이(가) 픽업 준비되었습니다.');
                    fetchPendingOrders(); // 목록 갱신
                } else {
                    alert('주문 상태 업데이트에 실패했습니다.');
                }
            });
        }

        // orderTable 파싱
        function parseOrderTable(orderTable) {
            const [type, storeInfo] = orderTable.split(' : ');
            const tableInfo = type === '0' ? '픽업 주문' : `매장 주문 - 테이블 번호: ${type}`;
            const storeName = storeInfo || '알 수 없는 매장';
            return { tableInfo, storeName };
        }

        // 페이지 로드 시 매장 정보 및 주문 데이터 가져오기
        window.onload = function() {
            fetchStores();
            fetchPendingOrders();

            // 매장 선택 시 데이터 갱신
            document.getElementById('storeSelector').addEventListener('change', fetchPendingOrders);
        };
    </script>
</body>
</html>
